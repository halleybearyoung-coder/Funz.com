<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funzo Bot Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-teal': '#0d9488',
                        'secondary-gray': '#4b5563',
                        'primary-blue': '#3b82f6',
                        'console-bg': '#111827',
                        'code-bg': '#1f2937',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code&display=swap" rel="stylesheet">
    <style>
        .chat-window {
            height: 85vh;
            max-height: 900px;
        }
        #chat-messages {
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        /* Code Block Styling */
        pre {
            background-color: #1f2937; 
            color: #f3f4f6; 
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            font-family: 'Courier New', Courier, monospace;
            border: 1px solid #374151;
        }
        code {
            font-family: 'Courier New', Courier, monospace;
        }
        
        /* Bold Text Styling */
        strong, b {
            font-weight: 700;
            color: #111827;
        }

        /* Custom styles for rendered headers */
        .msg-h1 { font-size: 1.5rem; font-weight: 800; margin-top: 0.5rem; margin-bottom: 0.25rem; color: #1f2937; }
        .msg-h2 { font-size: 1.25rem; font-weight: 700; margin-top: 0.4rem; margin-bottom: 0.2rem; color: #1f2937; }
        .msg-h3 { font-size: 1rem; font-weight: 600; margin-top: 0.3rem; margin-bottom: 0.1rem; color: #1f2937; }


        .loading-dot {
            animation: pulse 1s infinite;
        }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        /* Style for the copy button */
        .copy-btn {
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        .bot-message-container:hover .copy-btn {
            opacity: 1;
        }
    </style>
</head>
<body class="font-sans bg-gray-200 flex items-center justify-center min-h-screen p-4">

    <!-- Chat Container -->
    <div class="chat-window w-full max-w-5xl bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden">
        
        <!-- Header -->
        <header class="p-4 border-b border-gray-200 bg-white flex items-center justify-between shadow-sm z-10">
            <div class="flex items-center">
                <!-- No Icon/Avatar Here anymore -->
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Funzo Bot</h1>
                    <p class="text-xs text-gray-500">Powered by Gemini</p>
                </div>
            </div>
            <!-- Simple reset button -->
            <button onclick="location.reload()" class="text-gray-400 hover:text-gray-600 transition" title="Reset Chat">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            </button>
        </header>

        <!-- Message Feed -->
        <div id="chat-messages" class="flex-grow p-6 space-y-6 bg-gray-50">
            <!-- Initial Welcome Message will be injected here via JS -->
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t border-gray-200">
            <div class="relative flex items-end bg-gray-100 border border-gray-300 rounded-xl focus-within:ring-2 focus-within:ring-primary-teal focus-within:border-transparent transition-shadow shadow-inner p-2">
                <textarea 
                    id="message-input" 
                    rows="1" 
                    placeholder="Ask me anything..." 
                    class="flex-grow bg-transparent border-none focus:ring-0 p-2 resize-none max-h-32 text-gray-800 placeholder-gray-500"
                    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                ></textarea>
                <button 
                    id="send-button" 
                    onclick="sendMessage()" 
                    class="p-2 bg-primary-teal text-white rounded-lg hover:bg-teal-700 transition-colors shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed mb-0.5"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript LLM Logic -->
    <script>
        // Use the v1beta model endpoint for best compatibility
        const API_URL_BASE = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';
        const apiKey = ""; // Empty, relying on environment auth

        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        
        let isGenerating = false;
        let chatHistory = []; 

        const systemInstruction = {
            parts: [{ text: "You are Funzo, a friendly, helpful, and concise assistant made by Halley Young. You help users with coding, brainstorming, and general knowledge. Your tone is supportive and appropriate for a younger audience. Use markdown to format headers and bold text." }]
        };

        // --- UI UTILITIES ---

        function formatMessageText(text) {
            // 1. Escape HTML first
            let safeText = text.replace(/&/g, "&amp;")
                               .replace(/</g, "&lt;")
                               .replace(/>/g, "&gt;");
            
            // 2. Markdown Header Conversion (FIXED)
            // Use (?:<br>)? to optionally consume a preceding <br> if present
            safeText = safeText.replace(/^(?:<br>)?#\s*(.*)$/gm, '<h1 class="msg-h1">$1</h1>');
            safeText = safeText.replace(/^(?:<br>)?##\s*(.*)$/gm, '<h2 class="msg-h2">$1</h2>');
            safeText = safeText.replace(/^(?:<br>)?###\s*(.*)$/gm, '<h3 class="msg-h3">$1</h3>');

            // 3. Format Code Blocks
            safeText = safeText.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                const escapedCode = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                return `<pre><div class="text-xs text-gray-400 border-b border-gray-600 pb-1 mb-2 select-none">${lang || 'code'}</div><code>${escapedCode}</code></pre>`;
            });
            
            // 4. Format Inline Code
            safeText = safeText.replace(/`([^`]+)`/g, '<code class="bg-gray-200 text-red-600 px-1.5 py-0.5 rounded-md text-sm font-mono">$1</code>');

            // 5. Format Bold Text (FIXED)
            safeText = safeText.replace(/\*\*(.*?)\*\*/g, '<strong class="text-gray-900 font-bold">$1</strong>');

            // 6. Line breaks
            return safeText.replace(/\n/g, '<br>');
        }

        function setInputState(disabled) {
            isGenerating = disabled;
            sendButton.disabled = disabled;
            messageInput.disabled = disabled;
            messageInput.placeholder = disabled ? "Bot is responding..." : "Ask me anything...";
            if(!disabled) {
                messageInput.focus();
            }
        }

        function appendMessage(sender, text, isBot, isLoading = false) {
            const messageElement = document.createElement('div');
            messageElement.className = `flex ${isBot ? 'justify-start' : 'justify-end'}`;
            
            const rawTextToCopy = text.replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            let content = '';
            if (isLoading) {
                 content = `<div id="loading-indicator" class="bg-white border border-gray-200 p-4 rounded-2xl rounded-tl-none shadow-sm flex items-center space-x-2">
                                <span class="text-gray-500 text-sm font-medium">Thinking</span>
                                <div class="flex space-x-1">
                                    <span class="loading-dot w-1.5 h-1.5 bg-primary-teal rounded-full"></span>
                                    <span class="loading-dot w-1.5 h-1.5 bg-primary-teal rounded-full"></span>
                                    <span class="loading-dot w-1.5 h-1.5 bg-primary-teal rounded-full"></span>
                                </div>
                            </div>`;
            } else if (isBot) {
                 content = `<div class="bg-white border border-gray-200 p-5 rounded-2xl rounded-tl-none max-w-3xl shadow-sm bot-message-container group relative">
                                <div class="flex justify-between items-center mb-1">
                                    <p class="font-semibold text-primary-teal">${sender}</p>
                                    <button class="copy-btn text-gray-400 hover:text-primary-teal transition opacity-0 group-hover:opacity-100" onclick="copyText(this, '${rawTextToCopy}')" title="Copy text">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                    </button>
                                </div>
                                <div class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${formatMessageText(text)}</div>
                            </div>`;
            } else {
                 content = `<div class="bg-primary-teal text-white rounded-2xl rounded-tr-none p-4 max-w-2xl shadow-md">
                                <p class="font-semibold text-white mb-1">${sender}</p>
                                <p class="text-white whitespace-pre-wrap text-sm leading-relaxed">${text}</p>
                            </div>`;
            }

            messageElement.innerHTML = content;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator && indicator.parentElement) {
                indicator.parentElement.remove();
            }
        }

        // --- Copy to Clipboard Function ---
        window.copyText = function(button, text) {
            const textarea = document.createElement('textarea');
            // Remove markdown syntax before copying
            let cleanText = text.replace(/#+/g, '').replace(/\*\*/g, '');
            textarea.value = cleanText;

            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>';
                setTimeout(() => {
                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>';
                }, 1500);
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            
            document.body.removeChild(textarea);
        }

        // --- LLM API LOGIC ---

        async function fetchBotResponse(userQuery) {
            setInputState(true);
            appendMessage('Funzo Bot', '', true, true); 

            const fullApiUrl = `${API_URL_BASE}?key=${apiKey}`;

            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });

            const payload = {
                contents: chatHistory,
                systemInstruction: systemInstruction,
            };

            try {
                const response = await fetch(fullApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const result = await response.json();
                
                removeLoadingIndicator();
                setInputState(false);

                const candidate = result?.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let botText = candidate.content.parts[0].text;
                    
                    appendMessage('Funzo Bot', botText, true);
                    chatHistory.push({ role: "model", parts: [{ text: botText }] });
                } else {
                    appendMessage('Funzo Bot', "I'm sorry, I couldn't generate a response.", true);
                    chatHistory.pop();
                }

            } catch (error) {
                console.error(error);
                removeLoadingIndicator();
                setInputState(false);
                appendMessage('Funzo Bot', `⚠️ Error: ${error.message}`, true);
                chatHistory.pop();
            }
        }

        // --- EVENT HANDLERS ---

        window.sendMessage = function() {
            const text = messageInput.value.trim();
            if (!text) return;
            messageInput.value = '';
            messageInput.style.height = 'auto'; 
            appendMessage('You', text, false);
            fetchBotResponse(text);
        }

        window.handleKeyDown = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                window.sendMessage();
            }
        }
        
        // --- INITIALIZATION ---

        function initApp() {
            // 1. Assign DOM elements to global variables (CRITICAL FIX)
            window.chatMessages = document.getElementById('chat-messages');
            window.messageInput = document.getElementById('message-input');
            window.sendButton = document.getElementById('send-button');

            // 2. Send Initial Welcome Message
            setTimeout(() => {
                appendMessage('Funzo Bot', "Hello! I'm **Funzo Bot**. Ask me anything—I can write code, explain topics, or just chat!", true);
            }, 200);

            // 3. Set up Listeners (Now that variables are defined)
            sendButton.addEventListener('click', window.sendMessage);
            messageInput.addEventListener('keydown', window.handleKeyDown);
            
            // 4. Set initial input state (unlocked)
            setInputState(false);
        }

        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
