// ------------------------------------------------------------
// ONE-SINGLE-FILE GEMINI 2.5 FLASH SERVER + CLIENT UI
// ------------------------------------------------------------
import express from "express";
import path from "path";
import { GoogleGenerativeAI } from "@google/generative-ai";

const app = express();
app.use(express.json());

// ------------------------------------------------------------
// 1. INLINE BASE64-ENCODED HTML APP (Gemini-style interface)
// ------------------------------------------------------------
const htmlBase64 = `
PGh0bWw+CiAgPGhlYWQ+CiAgICAgIDxtZXRhIGNoYXJzZXQ9InV0Zi04Ij4KICAgICAgPHRpdGxl
PkdFTUlOSSBBUFA8L3RpdGxlPgogICAgICA8c3R5bGU+CiAgICAgICAgYm9keSB7CiAgICAgICAg
ICAgIGJhY2tncm91bmQ6ICMyMjI7CiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICAg
ICAgZm9udC1mYW1pbHk6IHNhbnMtc2VyaWY7CiAgICAgICAgICAgIG1hcmdpbjogMDsKICAgICAg
ICAgICAgcGFkZGluZzogMjBweDsKICAgICAgICB9CiAgICAgICAgI2NoYXQgewogICAgICAgICAg
ICBib3JkZXI6IDFweCBzb2xpZCB3aGl0ZTsKICAgICAgICAgICAgcGFkZGluZzogMTBweDsKICAg
ICAgICAgICAgbWF4LWhlaWdodDogNzB2aDsKICAgICAgICAgICAgb3ZlcmZsb3cteTogc2Nyb2xs
OwogICAgICAgIH0KICAgICAgICAjbXNnc19jb250YWluZXIgewogICAgICAgICAgICBtYXJnaW4t
dG9wOiAxMHB4OwogICAgICAgIH0KICAgICAgICAubXNnIHsKICAgICAgICAgICAgcGFkZGluZzog
MTBweDsKICAgICAgICB9CiAgICAgICAgLmFpIHsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzMz
MzsKICAgICAgICAgICAgcGFkZGluZzogMTBweDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czog
OHB4OwogICAgICAgIH0KICAgICAgPC9zdHlsZT4KICA8L2hlYWQ+CiAgPGJvZHk+CiAgICA8aDE+
R0VNSU5JIDIuNSBGTElTIA0KICAgIDwvaDE+CiAgICA8ZGl2IGlkPSJjaGF0Ij48L2Rpdj4KICAg
IDxkaXYgaWQ9Im1zZ3NfY29udGFpbmVyIj48L2Rpdj4KICAgIDxmb3JtIGlkPSJmb3JtIj4KICAg
ICAgPGlucHV0IGlkPSJ0eHQiIHBsYWNlaG9sZGVyPSJTYXkgaGVyZSIgc3R5bGU9IndpZHRoOiA4
MCU7IHBhZGRpbmc6IDEwcHg7IGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7IGJvcmRlci1yYWRpdXM6
IDVweDsiIC8+CiAgICAgIDxidXR0b24gc3R5bGU9InBhZGRpbmc6IDEwcHggMjBweDsgbWFyZ2lu
LWxlZnQ6IDEwcHg7IGJvcmRlcjogbm9uZTsgYm9yZGVyLXJhZGl1czogNHB4OyBiYWNrZ3JvdW5k
OiAjNjY2OyBjb2xvcjogI2ZmZiIgdHlwZT0ic3VibWl0Ij5TZW5kPC9idXR0b24+CiAgICA8L2Zv
cm0+CiAgICA8c2NyaXB0PgogICAgICBjb25zdCBjaGF0Qm94ID0gZG9jdW1lbnQuZ2V0RWxlbWVu
dEJ5SWQoImNoYXQiKTsKICAgICAgY29uc3QgbXNncyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlk
KCJtc2dzX2NvbnRhaW5lciIpOwogICAgICBjb25zdCBmb3JtID0gZG9jdW1lbnQuZ2V0RWxlbWVu
dEJ5SWQoImZvcm0iKTsKICAgICAgY29uc3QgdHh0ID0gZG9jdW1lbnQuZ2V0RWxlbWVuZW50QnlJ
ZCgicHhUIik7CiAgICAgIGZvcm0uYWRkRXZlbnRMaXN0ZW5lcigiaW5wdXQiLCBhc3luYyAoZSk9
PntlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgY29uc3QgbXNnID0gdHh0LnZhbHVlLnRyaW0o
KTsKICAgICAgICBpZiAoIW1zZykgcmV0dXJuOwogICAgICAgIHBvc3RNZXNzYWdlKCJ5b3UiLCBt
c2cpOwogICAgICAgIHR4dC52YWx1ZSA9ICIiOwogICAgICAgIGNvbnN0IHNlc3MgPSBuZXQgRXZl
bnRTb3VyY2UoIi9hcGkvY2hhdCIsIHsKICAgICAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICAg
ICAgIGhlYWRlcnM6IHsgIkNvbnRlbnQtdHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LAogICAg
ICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogbXNnLCBoaXN0b3J5OiBnZXRB
bGxNZXNzYWdlcygpIH0pCiAgICAgICAgfSk7CiAgICAgICAgZm9yIGF3YWl0IChjb25zdCBjaHVu
ayBvZiBzZXNzKSB7CiAgICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShjaHVuay5kYXRh
KTsKICAgICAgICAgICBhcHBlbmRMdW5lKCJnZW1pbmkiLCBkYXRhLmNob3BzKTsKICAgICAgICB9
CiAgICAgIH0pOwogICAgICBmdW5jdGlvbiBhZGRNZXNzYWdlKHJvbGUsIHRleHQpIHsKICAgICAg
ICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBkaXYu
c3R5bGUucGFkZGluZz0iMTBweCI7CiAgICAgICAgZGl2LnN0eWxlLm1hcmdpbj0iMTBweCAwIjtc
CiAgICAgICAgZGl2LnN0eWxlYmFja2dyb3VuZD0gI3MzMzsKICAgICAgICBkaXYuaW5uZXJUZXh0
ID0gIjxiPiIgKyByb2xlICsgIjwvYj46ICIgKyB0ZXh0OwogICAgICAgIG1zZ3MuYXBwZW5kQ2hp
bGQoZGl2KTsKICAgICAgICBtc2dzLnNjcm9sbFRvcCA9IG1zZ3Muc2Nyb2xsSGVpZ2h0OwogICAg
ICB9CiAgICAgIGZ1bmN0aW9uIGdldEFsbE1lc3NhZ2VzKCkgewogICAgICAgIHJldHVybiBbXTsK
ICAgICAgfQogICAgICBmdW5jdGlvbiBhcHBlbmRMdW5lKHJvbGUsIHRleHQpIHsKICAgICAgICBh
ZGRNZXNzYWdlKHJvbGUsIHRleHQpOwogICAgICB9CiAgICA8L3NjcmlwdD4KICA8L2JvZHk+Cjwv
aHRtbD4=
`;

// Serve decoded HTML
app.get("/", (req, res) => {
  const html = Buffer.from(htmlBase64, "base64").toString("utf-8");
  res.set("Content-Type", "text/html");
  res.send(html);
});

// ------------------------------------------------------------
// 2. GEMINI 2.5 FLASH CHAT ENDPOINT (STREAMING)
// ------------------------------------------------------------
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

app.post("/api/chat", async (req, res) => {
  res.setHeader("Content-Type", "text/event-stream");
  res.setHeader("Cache-Control", "no-cache");
  res.setHeader("Connection", "keep-alive");

  const { message } = req.body;

  const chat = await model.generateContentStream({
    contents: [{ role: "user", parts: [{ text: message }] }],
  });

  for await (const chunk of chat.stream) {
    const text = chunk.text();
    res.write(JSON.stringify({ chops: text }) + "\n");
  }

  res.end();
});

// ------------------------------------------------------------
const PORT = 3000;
app.listen(PORT, () =>
  console.log(`Server running â†’ http://localhost:${PORT}`)
);

