<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funz AI Code Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-teal': '#0d9488',
                        'secondary-gray': '#4b5563',
                        'primary-blue': '#3b82f6',
                        'console-bg': '#111827',
                        'code-bg': '#1f2937',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code&display=swap" rel="stylesheet">
    <style>
        /* General Layout */
        .chat-window {
            height: 85vh;
            max-height: 900px;
        }
        #chat-messages {
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        /* Code Block Styling */
        pre {
            background-color: #1f2937; 
            color: #f3f4f6; 
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            font-family: 'Courier New', Courier, monospace;
            border: 1px solid #374151;
        }
        code {
            font-family: 'Courier New', Courier, monospace;
        }
        
        /* Bold Text Styling */
        strong, b {
            font-weight: 700;
            color: #111827;
        }

        /* Custom styles for rendered headers */
        .msg-h1 { font-size: 1.5rem; font-weight: 800; margin-top: 0.5rem; margin-bottom: 0.25rem; color: #1f2937; }
        .msg-h2 { font-size: 1.25rem; font-weight: 700; margin-top: 0.4rem; margin-bottom: 0.2rem; color: #1f2937; }
        .msg-h3 { font-size: 1rem; font-weight: 600; margin-top: 0.3rem; margin-bottom: 0.1rem; color: #1f2937; }


        .loading-dot {
            animation: pulse 1s infinite;
        }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        /* Style for the copy button */
        .copy-btn {
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        .bot-message-container:hover .copy-btn {
            opacity: 1;
        }
        /* Ensure responsive textarea */
        textarea {
            min-height: 48px; /* Based on p-2 + mb-0.5 and font size */
        }
    </style>
</head>
<body class="font-sans bg-gray-200 flex items-center justify-center min-h-screen p-4">

    <!-- Chat Container -->
    <div class="chat-window w-full max-w-5xl bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden">
        
        <!-- Header -->
        <header class="p-4 border-b border-gray-200 bg-white flex items-center justify-between shadow-sm z-10">
            <div class="flex items-center">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Funzo Bot</h1>
                    <p class="text-xs text-gray-500">Powered by Gemini</p>
                </div>
            </div>
            <!-- Simple reset button -->
            <button onclick="location.reload()" class="text-gray-400 hover:text-gray-600 transition" title="Reset Chat">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            </button>
        </header>

        <!-- Message Feed -->
        <div id="chat-messages" class="flex-grow p-6 space-y-6 bg-gray-50">
            <!-- Initial Welcome Message will be injected here via JS -->
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t border-gray-200">
            <div class="relative flex items-end bg-gray-100 border border-gray-300 rounded-xl focus-within:ring-2 focus-within:ring-primary-teal focus-within:border-transparent transition-shadow shadow-inner p-2">
                <textarea 
                    id="message-input" 
                    rows="1" 
                    placeholder="Ask me anything..." 
                    class="flex-grow bg-transparent border-none focus:ring-0 p-2 resize-none max-h-32 text-gray-800 placeholder-gray-500"
                    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                ></textarea>
                <button 
                    id="send-button" 
                    class="p-2 bg-primary-teal text-white rounded-lg hover:bg-teal-700 transition-colors shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed mb-0.5"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript LLM Logic -->
    <script>
        // --- CONFIG & API ---
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        const API_URL_BASE = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;
        
        // IMPORTANT SECURITY NOTE for GitHub Deployment: 
        // 1. In this environment (Canvas), the apiKey is automatically provided when it's an empty string.
        // 2. If you deploy this file to a **public** GitHub Page, you **MUST** replace the "" with your actual key for it to work.
        // 3. ⚠️ WARNING: Putting your key directly in this file makes it public and insecure! 
        //    For permanent, secure deployment, you must use a serverless function (like Cloud Functions or AWS Lambda) 
        //    to hide the key on a public website.
        const apiKey = ""; 
        // For local testing on your machine or for a public GitHub deployment (INSECURE!), 
        // uncomment the line below and replace "YOUR_SECRET_API_KEY_HERE" with your key:
        // const apiKey = "AIzaSyAa_MJQWW-1kpJXBOY7ZR_uELYeXj3Di_8";


        // Global DOM element references
        let chatMessages;
        let messageInput;
        let sendButton;
        
        let isGenerating = false;
        let chatHistory = []; 

        const systemInstruction = {
            parts: [{ text: "You are Funzo Bot, a friendly, helpful, and concise assistant. You help users with coding, brainstorming, and general knowledge. Your tone is supportive and appropriate for a younger audience. Use markdown to format headers and bold text." }]
        };

        // --- UI UTILITIES ---

        function formatMessageText(text) {
            let safeText = text.replace(/&/g, "&amp;")
                               .replace(/</g, "&lt;")
                               .replace(/>/g, "&gt;");
            
            // 1. Markdown Header Conversion
            safeText = safeText.replace(/^(?:<br>)?###\s*(.*)$/gm, '<h3 class="msg-h3">$1</h3>');
            safeText = safeText.replace(/^(?:<br>)?##\s*(.*)$/gm, '<h2 class="msg-h2">$1</h2>');
            safeText = safeText.replace(/^(?:<br>)?#\s*(.*)$/gm, '<h1 class="msg-h1">$1</h1>');

            // 2. Format Code Blocks
            safeText = safeText.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                // IMPORTANT: The code content inside the PRE block needs to be HTML escaped
                const escapedCode = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                return `<pre><div class="text-xs text-gray-400 border-b border-gray-600 pb-1 mb-2 select-none">${lang || 'code'}</div><code>${escapedCode}</code></pre>`;
            });
            
            // 3. Format Inline Code
            safeText = safeText.replace(/`([^`]+)`/g, '<code class="bg-gray-200 text-red-600 px-1.5 py-0.5 rounded-md text-sm font-mono">$1</code>');

            // 4. Format Bold Text
            safeText = safeText.replace(/\*\*(.*?)\*\*/g, '<strong class="text-gray-900 font-bold">$1</strong>');
            
            // 5. Format Italic Text (single asterisk or underscore)
            safeText = safeText.replace(/(^|[^a-zA-Z0-9])\*([^\*]+?)\*([^a-zA-Z0-9]|$)/g, '$1<em>$2</em>$3');
            safeText = safeText.replace(/(^|[^a-zA-Z0-9])_([^_]+?)_([^a-zA-Z0-9]|$)/g, '$1<em>$2</em>$3');

            // 6. Line breaks
            return safeText.replace(/\n/g, '<br>');
        }

        function setInputState(disabled) {
            isGenerating = disabled;
            sendButton.disabled = disabled;
            messageInput.disabled = disabled;
            messageInput.placeholder = disabled ? "Bot is responding..." : "Ask me anything...";
            if(!disabled) {
                messageInput.focus();
            }
        }

        function appendMessage(sender, text, isBot, isLoading = false) {
            if (!chatMessages) return; 

            const messageElement = document.createElement('div');
            messageElement.className = `flex ${isBot ? 'justify-start' : 'justify-end'}`;
            
            // Prepare raw text for the copy function
            let rawTextToCopy = text.replace(/"/g, '&quot;'); 
            
            let content = '';
            if (isLoading) {
                 content = `<div id="loading-indicator" class="bg-white border border-gray-200 p-4 rounded-2xl rounded-tl-none shadow-sm flex items-center space-x-2">
                                <span class="text-gray-500 text-sm font-medium">Thinking</span>
                                <div class="flex space-x-1">
                                    <span class="loading-dot w-1.5 h-1.5 bg-primary-teal rounded-full"></span>
                                    <span class="loading-dot w-1.5 h-1.5 bg-primary-teal rounded-full"></span>
                                    <span class="loading-dot w-1.5 h-1.5 bg-primary-teal rounded-full"></span>
                                </div>
                            </div>`;
            } else if (isBot) {
                 // Use the copy function on the whole rendered text, not just raw text, for code blocks
                 content = `<div class="bg-white border border-gray-200 p-5 rounded-2xl rounded-tl-none max-w-3xl shadow-sm bot-message-container group relative">
                                <div class="flex justify-between items-center mb-1">
                                    <p class="font-semibold text-primary-teal">${sender}</p>
                                    <button class="copy-btn text-gray-400 hover:text-primary-teal transition opacity-0 group-hover:opacity-100" onclick="copyText(this, '${rawTextToCopy}')" title="Copy text">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                    </button>
                                </div>
                                <div class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${formatMessageText(text)}</div>
                            </div>`;
            } else {
                 content = `<div class="bg-primary-teal text-white rounded-2xl rounded-tr-none p-4 max-w-2xl shadow-md">
                                <p class="font-semibold text-white mb-1">${sender}</p>
                                <p class="text-white whitespace-pre-wrap text-sm leading-relaxed">${formatMessageText(text)}</p>
                            </div>`;
            }

            messageElement.innerHTML = content;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator && indicator.parentElement) {
                indicator.parentElement.remove();
            }
        }

        // --- Copy to Clipboard Function ---
        window.copyText = function(button, text) {
            const textarea = document.createElement('textarea');
            // Remove markdown syntax before copying
            let cleanText = text.replace(/#+/g, '').replace(/\*\*/g, '').replace(/\*/g, '').replace(/_/g, '').replace(/`/g, '');
            // Decode HTML entities if they were used for escaping (like &quot;)
            cleanText = cleanText.replace(/&quot;/g, '"');


            textarea.value = cleanText;

            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>';
                setTimeout(() => {
                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>';
                }, 1500);
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            
            document.body.removeChild(textarea);
        }

        // --- LLM API LOGIC with Retry ---

        async function fetchWithRetry(url, options, maxRetries = 5) {
            let lastError = null;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    // For non-ok responses (4xx, 5xx), we try to get more details before retrying
                    const errorDetails = await response.json().catch(() => ({}));
                    lastError = new Error(`API Error ${response.status}: ${errorDetails.error?.message || response.statusText}`);
                    
                    // If it's a 4xx error (like 400 Bad Request), don't retry, it's a permanent error
                    if (response.status >= 400 && response.status < 500) {
                        break;
                    }

                } catch (error) {
                    lastError = error;
                }

                if (i < maxRetries - 1) {
                    const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000); // Exponential backoff + jitter
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw lastError;
        }


        async function fetchBotResponse(userQuery) {
            setInputState(true);
            appendMessage('Funzo Bot', '', true, true); 

            // API URL includes the key parameter for the Canvas environment
            const fullApiUrl = `${API_URL_BASE}?key=${apiKey}`;

            // Add user message to history *before* the API call
            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });

            const payload = {
                contents: chatHistory,
                systemInstruction: systemInstruction,
            };

            try {
                const response = await fetchWithRetry(fullApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                removeLoadingIndicator();
                setInputState(false);

                const candidate = result?.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const botText = candidate.content.parts[0].text;
                    appendMessage('Funzo Bot', botText, true);
                    // Add bot response to history
                    chatHistory.push({ role: "model", parts: [{ text: botText }] });
                } else {
                    // Handle cases where API returns status 200 but no content (e.g., filtered response)
                    const errorReason = result.candidates?.[0]?.finishReason || 'Unknown API issue';
                    appendMessage('Funzo Bot', `I'm sorry, I couldn't generate a response. Reason: ${errorReason}. Check the browser console for details.`, true);
                    // Remove the last user query as it wasn't successfully processed
                    chatHistory.pop();
                }

            } catch (error) {
                console.error("Critical Fetch Error:", error);
                removeLoadingIndicator();
                setInputState(false);
                appendMessage('Funzo Bot', `⚠️ Critical Error: Could not connect to the service. Please check your network and API key. Details: ${error.message}`, true);
                chatHistory.pop(); // Remove the user query
            }
        }

        // --- EVENT HANDLERS ---

        window.sendMessage = function() {
            if (isGenerating) return; // Prevent double send
            const text = messageInput.value.trim();
            if (!text) return;
            
            appendMessage('You', text, false); 
            
            messageInput.value = '';
            // Reset textarea height after sending
            messageInput.style.height = 'auto'; 
            fetchBotResponse(text);
        }

        window.handleKeyDown = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                window.sendMessage();
            }
        }
        
        // --- INITIALIZATION ---

        function initApp() {
            // 1. Assign DOM elements
            chatMessages = document.getElementById('chat-messages');
            messageInput = document.getElementById('message-input');
            sendButton = document.getElementById('send-button');

            // 2. Set up Listeners 
            if (sendButton && messageInput) {
                sendButton.addEventListener('click', window.sendMessage);
                messageInput.addEventListener('keydown', window.handleKeyDown);
            }
            
            // 3. Send Initial Welcome Message
            setTimeout(() => {
                appendMessage('Funzo Bot', "Hello! I'm **Funzo Bot**. Ask me anything—I can write code, explain topics, or just chat!", true);
            }, 200);
            
            // 4. Set initial input state (unlocked)
            setInputState(false);
        }

        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
